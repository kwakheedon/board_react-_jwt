package com.example.board.domain.post;

import java.util.List;

import org.springframework.http.ResponseEntity;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
import com.example.board.security.jwt.CustomUserDetails;
import com.example.board.domain.post.dto.PostAllRes;
import com.example.board.domain.post.dto.PostDetailRes;
import com.example.board.domain.post.dto.PostReq;
import com.example.board.domain.post.dto.PostUserRes;
import com.example.board.exception.ApiResponse;

import lombok.RequiredArgsConstructor;


@RestController
@RequestMapping("/api") 
@RequiredArgsConstructor
public class PostController {
	private final PostService postService;
	
	//ê²Œì‹œê¸€ìƒì„±
	@PostMapping("/posts")
	public ResponseEntity<ApiResponse<Long>> createPost(
	        @RequestBody PostReq postReq,
	        @AuthenticationPrincipal CustomUserDetails userDetails) {

	    //ë°›ì•„ì˜¨ userDetails ê°ì²´ì—ì„œ ì´ë©”ì¼ì„ ì¶”ì¶œ
		String email = userDetails.getMember().getEmail();

	    //ì„œë¹„ìŠ¤ í˜¸ì¶œ 
	    Long postId = postService.create(postReq, email);

	    //ìƒì„±ëœ ê²Œì‹œê¸€ì˜ IDë¥¼ ë°˜í™˜
	    return ResponseEntity.ok(ApiResponse.success("ê²Œì‹œê¸€ ìƒì„± ì„±ê³µ", postId));
	}
	
	//ê²Œì‹œê¸€ IDë¡œ ìƒì„¸ ì¡°íšŒ
	@GetMapping("/posts/{postId}")
	public ResponseEntity<ApiResponse<PostDetailRes>> getPost(@PathVariable Long postId) { 
	    
	    PostDetailRes postDetail = postService.findPostById(postId); 

	    return ResponseEntity.ok(ApiResponse.success("ê²Œì‹œê¸€ ì¡°íšŒ ì„±ê³µ", postDetail));
	}
	
	//ì „ì²´ ê²Œì‹œê¸€ ëª©ë¡ ì¡°íšŒ
	@GetMapping("/allpost")
	public ResponseEntity<ApiResponse<List<PostAllRes>>> allPost() {
	    List<PostAllRes> posts = postService.findAllPosts();
	    return ResponseEntity.ok(ApiResponse.success("ì „ì²´ ê²Œì‹œê¸€ ì¡°íšŒ ì„±ê³µ", posts));
	}
	
	//íŠ¹ì • ì‚¬ìš©ìê°€ ì“´ ê²Œì‹œê¸€ ëª©ë¡ ì¡°íšŒ (GET /api/posts?userId={id})
	@GetMapping("/api/posts?userId={id}")
    public ResponseEntity<ApiResponse<List<PostAllRes>>> getPostsByUserEmail(
            @RequestParam String email) { // ğŸ’¡ RequestParamìœ¼ë¡œ email ê°’ì„ ë°›ìŠµë‹ˆë‹¤.

        // 1. emailì„ ì„œë¹„ìŠ¤ ë©”ì†Œë“œë¡œ ì „ë‹¬í•˜ì—¬ ê²°ê³¼(DTO ë¦¬ìŠ¤íŠ¸)ë¥¼ ë°›ìŠµë‹ˆë‹¤.
        List<PostAllRes> userPosts = postService.findPostsByEmail(email);
        
        // 2. ì„±ê³µ ì‘ë‹µì„ ë°˜í™˜í•©ë‹ˆë‹¤.
        return ResponseEntity.ok(ApiResponse.success("ì‚¬ìš©ì ê²Œì‹œê¸€ ëª©ë¡ ì¡°íšŒ ì„±ê³µ", userPosts));
    }

	
	
	
}
