package com.example.board.domain.post;

import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.example.board.domain.member.Member;
import com.example.board.domain.member.MemberRepository;
import com.example.board.domain.post.dto.PostReq;
import com.example.board.exception.CustomException;
import com.example.board.exception.ErrorCode;

import lombok.RequiredArgsConstructor;

@Service
@RequiredArgsConstructor
public class PostService {
	private final PostRepository postRepository;
	private final MemberRepository memberRepository;
	// 개시글 생성
	@Transactional
	public Long createPost(PostReq req, String email) {

		// 1. 작성자 정보 조회
		// 이 시점에는 이미 JWT 필터를 통과했으므로, 유효한 사용자라고 신뢰할 수 있습니다.
		Member member = memberRepository.findByEmail(email)
				.orElseThrow(() -> new CustomException(ErrorCode.USER_NOT_FOUND, "해당 사용자를 찾을 수 없습니다."));

		// 2. 게시글 엔티티 생성
		// DTO와 작성자 정보를 바탕으로 Post 객체를 만듭니다.
		Post post = Post.builder().title(req.getTitle()).content(req.getContent()).member(member) // 연관관계 설정 (이 게시글의
																									// 작성자는 누구인가)
				.build();

		// 3. 데이터베이스에 저장
		// save 메서드는 저장된 엔티티를 반환하며, ID 값이 채워져 있습니다.
		Post savedPost = postRepository.save(post);

		// 4. 생성된 게시글의 ID 반환
		return savedPost.getId();
	}

}
